rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function ownsResource() {
      return isAuthenticated() && (resource.data.userId == request.auth.uid);
    }

    function willOwnResource() {
      return isAuthenticated() && (request.resource.data.userId == request.auth.uid);
    }

    // ==================== MAIN USER COLLECTION ====================
    // This is the core of the "User-Centric" architecture.
    // All user data (goals, logs, profile) MUST be nested under /users/{userId}
    match /users/{userId} {
      allow read, write: if isOwner(userId);

      // RECURSIVE WILDCARD: Allows access to ALL subcollections
      // e.g. /users/{userId}/goals, /users/{userId}/foodLogs, etc.
      match /{document=**} {
        allow read, write: if isOwner(userId);
      }
    }

    // ==================== EXCEPTIONS (Valid Root Collections) ====================
    
    // Recommendations (AI Plans)
    // Kept at root to allow easy writing by AI services/Cloud Functions
    match /recommendations/{recommendationId} {
      allow create: if willOwnResource();
      allow read, update, delete: if ownsResource();
    }

    // Festival Calendar (Global Read-Only)
    match /festivalCalendar/{eventId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ==================== DENY ALL ELSE ====================
    // This strictly blocks any writes to root collections like /goals, /weightLogs, etc.
    // preventing the "messy" broken structure.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
